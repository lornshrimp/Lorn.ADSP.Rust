## 3. 外部协议对象设计

### 3.1 OpenRTB协议适配

#### 3.1.1 协议对象映射

| OpenRTB对象 | 业务含义 | 映射策略            | 扩展字段     |
| ----------- | -------- | ------------------- | ------------ |
| BidRequest  | 竞价请求 | 标准映射+自定义扩展 | 内部业务标识 |
| BidResponse | 竞价响应 | 标准格式+性能优化   | 调试信息     |
| Impression  | 广告展示 | 完整映射+验证逻辑   | 质量评分     |
| User        | 用户信息 | 隐私保护+画像映射   | 内部用户ID   |
| Device      | 设备信息 | 标准映射+设备指纹   | 反作弊标识   |

##### OpenRTB对象类图设计

```mermaid
classDiagram
    class OpenRTBObject {
        <<abstract trait>>
        +std::collections::HashMap~String,serde_json::Value~ ext
        +validate() -> Result~(), ValidationError~
        +to_json() -> Result~String, SerdeError~
        +from_json(json: &str) -> Result~Self, SerdeError~
        +get_version() -> &str
    }
    
    class BidRequest {
        +String id
        +Vec~Impression~ imp
        +Option~Site~ site
        +Option~App~ app
        +Option~Device~ device
        +Option~User~ user
        +Option~i32~ test
        +Option~i32~ at
        +Option~i32~ tmax
        +Option~Vec~String~~ wseat
        +Option~Vec~String~~ bseat
        +Option~i32~ allimps
        +Option~Vec~String~~ cur
        +Option~Vec~String~~ wlang
        +Option~Vec~String~~ bcat
        +Option~Vec~String~~ badv
        +Option~Vec~String~~ bapp
        +Option~Source~ source
        +Option~Regs~ regs
        +validate_request() -> Result~(), ValidationError~
        +get_impression_by_id(&self, id: &str) -> Option~&Impression~
        +is_test_request(&self) -> bool
        +get_request_timeout(&self) -> Option~Duration~
    }
    
    class BidResponse {
        +String id
        +Vec~SeatBid~ seatbid
        +Option~String~ bidid
        +Option~String~ cur
        +Option~String~ customdata
        +Option~i32~ nbr
        +validate_response() -> Result~(), ValidationError~
        +get_total_bid_amount(&self) -> rust_decimal::Decimal
        +get_winning_bids(&self) -> Vec~&Bid~
        +has_valid_bids(&self) -> bool
    }
    
    class Impression {
        +String id
        +Option~Vec~Metric~~ metric
        +Option~Banner~ banner
        +Option~Video~ video
        +Option~Audio~ audio
        +Option~Native~ native
        +Option~Pmp~ pmp
        +Option~String~ displaymanager
        +Option~String~ displaymanagerver
        +Option~i32~ instl
        +Option~String~ tagid
        +Option~rust_decimal::Decimal~ bidfloor
        +Option~String~ bidfloorcur
        +Option~i32~ clickbrowser
        +Option~i32~ secure
        +Option~Vec~String~~ iframebuster
        +Option~i32~ exp
        +get_ad_formats(&self) -> Vec~String~
        +supports_format(&self, format: &str) -> bool
        +get_floor_price(&self) -> rust_decimal::Decimal
        +is_secure(&self) -> bool
    }
    
    class User {
        +Option~String~ id
        +Option~String~ buyeruid
        +Option~i32~ yob
        +Option~String~ gender
        +Option~String~ keywords
        +Option~String~ customdata
        +Option~Geo~ geo
        +Option~Vec~Data~~ data
        +get_age(&self) -> Option~i32~
        +get_interests(&self) -> Vec~String~
        +get_location(&self) -> Option~GeoLocation~
        +has_data(&self) -> bool
        +get_user_segments(&self) -> Vec~String~
    }
    
    class Device {
        +Option~String~ ua
        +Option~Geo~ geo
        +Option~i32~ dnt
        +Option~i32~ lmt
        +Option~String~ ip
        +Option~String~ ipv6
        +Option~i32~ devicetype
        +Option~String~ make
        +Option~String~ model
        +Option~String~ os
        +Option~String~ osv
        +Option~String~ hwv
        +Option~i32~ h
        +Option~i32~ w
        +Option~i32~ ppi
        +Option~f64~ pxratio
        +Option~i32~ js
        +Option~i32~ geofetch
        +Option~String~ flashver
        +Option~String~ language
        +Option~String~ carrier
        +Option~i32~ mccmnc
        +Option~i32~ connectiontype
        +Option~String~ ifa
        +Option~String~ didsha1
        +Option~String~ didmd5
        +Option~String~ dpidsha1
        +Option~String~ dpidmd5
        +Option~String~ macsha1
        +Option~String~ macmd5
        +get_device_fingerprint(&self) -> String
        +is_mobile(&self) -> bool
        +get_screen_resolution(&self) -> Option~(i32, i32)~
        +supports_javascript(&self) -> bool
    }
    
    class SeatBid {
        +Vec~Bid~ bid
        +Option~String~ seat
        +Option~i32~ group
    }
    
    class Bid {
        +String id
        +String impid
        +rust_decimal::Decimal price
        +Option~String~ adid
        +Option~String~ nurl
        +Option~String~ burl
        +Option~String~ lurl
        +Option~String~ adm
        +Option~Vec~String~~ adomain
        +Option~String~ bundle
        +Option~String~ iurl
        +Option~String~ cid
        +Option~String~ crid
        +Option~i32~ tactic
        +Option~Vec~String~~ cat
        +Option~Vec~i32~~ attr
        +Option~i32~ api
        +Option~i32~ protocol
        +Option~i32~ qagmediarating
        +Option~String~ language
        +Option~String~ dealid
        +Option~i32~ w
        +Option~i32~ h
        +Option~i32~ wratio
        +Option~i32~ hratio
        +Option~i32~ exp
        +validate_bid() -> Result~(), ValidationError~
        +get_creative_url(&self) -> Option~&str~
        +get_impression_url(&self) -> Option~&str~
        +get_click_url(&self) -> Option~&str~
    }
    
    OpenRTBObject <|-- BidRequest
    OpenRTBObject <|-- BidResponse
    OpenRTBObject <|-- Impression
    OpenRTBObject <|-- User
    OpenRTBObject <|-- Device
    
    BidRequest *-- Impression
    BidRequest *-- User
    BidRequest *-- Device
    BidResponse *-- SeatBid
    SeatBid *-- Bid
```

##### OpenRTB协议版本兼容设计

```mermaid
graph TD
    A[OpenRTB请求] --> B{版本检测}
    B -->|2.5| C[OpenRTB 2.5处理器]
    B -->|2.4| D[OpenRTB 2.4处理器]
    B -->|2.3| E[OpenRTB 2.3处理器]
    B -->|未知| F[默认处理器]
    
    C --> G[标准对象映射]
    D --> H[兼容性转换]
    E --> I[向后兼容处理]
    F --> J[降级处理]
    
    G --> K[内部业务对象]
    H --> K
    I --> K
    J --> K
    
    K --> L[业务逻辑处理]
    L --> M[响应对象生成]
    M --> N[版本适配输出]
```

**协议适配策略**：

- **向后兼容**：新版本协议兼容旧版本请求，通过字段映射和默认值处理
- **扩展字段管理**：通过ext字段支持自定义扩展，保持协议标准性
- **验证机制**：多层次验证包括格式验证、业务规则验证、安全检查
- **性能优化**：对象池化、序列化优化、缓存策略

#### 3.1.2 协议版本兼容

```mermaid
graph TD
    A[协议适配层] --> B[OpenRTB 2.5]
    A --> C[OpenRTB 2.4]
    A --> D[OpenRTB 2.3]
    
    B --> E[标准对象]
    C --> F[兼容转换]
    D --> G[降级处理]
    
    E --> H[内部对象]
    F --> H
    G --> H
    
    H --> I[业务处理]
```

##### 协议版本适配架构

```mermaid
classDiagram
    class OpenRTBAdapter {
        <<trait>>
        +supported_version() -> &str
        +parse_bid_request(json: &str) -> Result~BidRequest, ParseError~
        +serialize_bid_response(response: &BidResponse) -> Result~String, SerdeError~
        +validate_request(request: &BidRequest) -> Result~(), ValidationError~
        +supports_feature(feature: &str) -> bool
    }
    
    class OpenRTBAdapterBase {
        <<abstract struct>>
        +version: String
        +logger: Arc~dyn Logger~
        +mapper: Arc~dyn ObjectMapper~
        +parse_bid_request(&self, json: &str) -> Result~BidRequest, ParseError~
        +serialize_bid_response(&self, response: &BidResponse) -> Result~String, SerdeError~
        +validate_common_fields(&self, request: &BidRequest) -> Result~(), ValidationError~
        +handle_extensions(&self, ext: &HashMap~String,Value~) -> HashMap~String,Value~
        +log_parsing_error(&self, error: &ParseError, json: &str)
    }
    
    class OpenRTB25Adapter {
        +supported_version: &'static str = "2.5"
        +parse_bid_request(&self, json: &str) -> Result~BidRequest, ParseError~
        +serialize_bid_response(&self, response: &BidResponse) -> Result~String, SerdeError~
        +validate_request(&self, request: &BidRequest) -> Result~(), ValidationError~
        +handle_new_features(&self, request: &BidRequest)
        +parse_advanced_targeting(&self, ext: &HashMap~String,Value~) -> AdvancedTargeting
    }
    
    class OpenRTB24Adapter {
        +supported_version: &'static str = "2.4"
        +parse_bid_request(&self, json: &str) -> Result~BidRequest, ParseError~
        +serialize_bid_response(&self, response: &BidResponse) -> Result~String, SerdeError~
        +validate_request(&self, request: &BidRequest) -> Result~(), ValidationError~
        +convert_to_25_format(&self, request: BidRequest) -> BidRequest
        +handle_deprecated_fields(&self, request: &mut BidRequest)
    }
    
    class OpenRTB23Adapter {
        +supported_version: &'static str = "2.3"
        +parse_bid_request(&self, json: &str) -> Result~BidRequest, ParseError~
        +serialize_bid_response(&self, response: &BidResponse) -> Result~String, SerdeError~
        +validate_request(&self, request: &BidRequest) -> Result~(), ValidationError~
        +upgrade_to_latest_version(&self, request: BidRequest) -> BidRequest
        +set_default_values(&self, request: &mut BidRequest)
    }
    
    class AdapterFactory {
        +adapters: HashMap~String,Box~dyn OpenRTBAdapter~~
        +get_adapter(&self, version: &str) -> Option~&dyn OpenRTBAdapter~
        +get_default_adapter(&self) -> &dyn OpenRTBAdapter
        +register_adapter(&mut self, adapter: Box~dyn OpenRTBAdapter~)
        +get_supported_versions(&self) -> Vec~&str~
    }
    
    class VersionDetector {
        +detect_version(&self, json: &str) -> Option~String~
        +detect_version_from_headers(&self, headers: &HeaderMap) -> Option~String~
        +parse_version_info(&self, version_string: &str) -> VersionInfo
        +is_version_supported(&self, version: &str) -> bool
    }
    
    class FieldMappingEngine {
        +mappings: HashMap~String,FieldMapping~
        +map_field(&self, field_name: &str, value: &Value, from_version: &str, to_version: &str) -> Value
        +map_extensions(&self, ext: &HashMap~String,Value~, version: &str) -> HashMap~String,Value~
        +register_mapping(&mut self, mapping: FieldMapping)
        +get_mapping_warnings(&self, from_version: &str, to_version: &str) -> Vec~String~
    }
    
    OpenRTBAdapter <|.. OpenRTBAdapterBase
    OpenRTBAdapterBase <|-- OpenRTB25Adapter
    OpenRTBAdapterBase <|-- OpenRTB24Adapter
    OpenRTBAdapterBase <|-- OpenRTB23Adapter
    
    AdapterFactory --> OpenRTBAdapter
    AdapterFactory --> VersionDetector
    OpenRTBAdapterBase --> FieldMappingEngine
```

**版本兼容性处理流程**：

```mermaid
sequenceDiagram
    participant Client as RTB客户端
    participant Detector as 版本检测器
    participant Factory as 适配器工厂
    participant Adapter as 协议适配器
    participant Mapper as 字段映射器
    participant Engine as 广告引擎
    
    Client->>Detector: 发送RTB请求
    Detector->>Detector: 检测协议版本
    Detector->>Factory: 获取对应适配器
    Factory-->>Detector: 返回适配器实例
    Detector->>Adapter: 解析请求对象
    
    alt 版本2.5
        Adapter->>Engine: 直接处理
    else 版本2.4或2.3
        Adapter->>Mapper: 字段映射转换
        Mapper-->>Adapter: 返回标准对象
        Adapter->>Engine: 处理转换后对象
    end
    
    Engine-->>Adapter: 返回处理结果
    Adapter->>Adapter: 生成响应对象
    Adapter-->>Client: 返回RTB响应
```

**映射策略和规则**：

- **字段映射表**：维护不同版本间的字段对应关系和转换规则
- **默认值处理**：为缺失字段提供合理的默认值，确保业务逻辑正常运行
- **扩展字段处理**：保持自定义扩展字段的完整性，支持业务特殊需求
- **验证增强**：在版本转换过程中增加额外的验证检查，确保数据质量

### 3.2 VAST协议支持

#### 3.2.1 视频广告对象

| VAST对象       | 功能作用       | 数据结构   | 处理策略 |
| -------------- | -------------- | ---------- | -------- |
| VASTDocument   | 广告文档根节点 | XML树结构  | 解析验证 |
| AdSystem       | 广告系统信息   | 标识信息   | 系统识别 |
| Creative       | 创意内容       | 多媒体资源 | 格式适配 |
| MediaFile      | 媒体文件       | 文件元信息 | 编码支持 |
| TrackingEvents | 跟踪事件       | 事件列表   | 监测埋点 |

##### VAST对象类图设计

```mermaid
classDiagram
    class VASTDocument {
        +String version
        +Vec~Ad~ ads
        +Vec~VastError~ errors
        +roxmltree::Document xml_document
        +parse_from_xml(xml: &str) -> Result~VASTDocument, ParseError~
        +to_xml(&self) -> Result~String, SerializeError~
        +validate_structure(&self) -> Result~(), ValidationError~
        +get_ad_by_id(&self, id: &str) -> Option~&Ad~
        +get_total_duration(&self) -> Duration
    }
    
    class Ad {
        +String id
        +Option~String~ sequence
        +AdSystem ad_system
        +Option~String~ ad_title
        +Option~String~ description
        +Vec~Creative~ creatives
        +Vec~Extension~ extensions
        +Option~Pricing~ pricing
        +Option~Survey~ survey
        +Vec~String~ errors
        +get_linear_creatives(&self) -> Vec~&Creative~
        +get_non_linear_creatives(&self) -> Vec~&Creative~
        +get_companion_creatives(&self) -> Vec~&Creative~
        +has_valid_creatives(&self) -> bool
    }
    
    class AdSystem {
        +String name
        +Option~String~ version
        +Option~String~ system_id
        +std::collections::HashMap~String,String~ attributes
        +get_system_info(&self) -> SystemInfo
        +is_known_system(&self) -> bool
        +get_capabilities(&self) -> Vec~String~
    }
    
    class Creative {
        +String id
        +Option~String~ ad_id
        +Option~String~ sequence
        +Option~String~ api_framework
        +Option~Linear~ linear
        +Vec~NonLinear~ non_linear_ads
        +Vec~CompanionAd~ companion_ads
        +Vec~String~ creative_extensions
        +get_creative_type(&self) -> CreativeType
        +get_duration(&self) -> Option~Duration~
        +get_media_files(&self) -> Vec~&MediaFile~
        +is_interactive(&self) -> bool
    }
    
    class Linear {
        +Duration duration
        +Option~Duration~ skip_offset
        +Vec~MediaFile~ media_files
        +Vec~TrackingEvent~ tracking_events
        +Option~VideoClicks~ video_clicks
        +Option~AdParameters~ ad_parameters
        +Vec~Icon~ icons
        +get_skip_offset(&self) -> Option~Duration~
        +get_best_media_file(&self, specs: &VideoSpecs) -> Option~&MediaFile~
        +get_tracking_urls(&self, event_type: TrackingEventType) -> Vec~&str~
    }
    
    class MediaFile {
        +Option~String~ id
        +String delivery
        +String media_type
        +Option~String~ codec
        +Option~i32~ bitrate
        +Option~i32~ width
        +Option~i32~ height
        +Option~bool~ scalable
        +Option~bool~ maintain_aspect_ratio
        +Option~String~ api_framework
        +String uri
        +get_file_size(&self) -> Option~u64~
        +get_resolution(&self) -> Option~(i32, i32)~
        +is_supported(&self, specs: &VideoSpecs) -> bool
        +get_quality_score(&self) -> f64
    }
    
    class TrackingEvent {
        +TrackingEventType event_type
        +Option~Duration~ offset
        +Vec~String~ tracking_urls
        +std::collections::HashMap~String,String~ parameters
        +get_trigger_offset(&self) -> Option~Duration~
        +should_trigger_at(&self, current_time: Duration) -> bool
        +get_tracking_pixels(&self) -> Vec~TrackingPixel~
    }
    
    class VideoClicks {
        +Vec~ClickThrough~ click_throughs
        +Vec~ClickTracking~ click_trackings
        +Vec~CustomClick~ custom_clicks
        +get_click_through_url(&self) -> Option~&str~
        +get_click_tracking_urls(&self) -> Vec~&str~
        +has_click_actions(&self) -> bool
    }
    
    class NonLinear {
        +String id
        +i32 width
        +i32 height
        +Option~i32~ expanded_width
        +Option~i32~ expanded_height
        +Option~bool~ scalable
        +Option~bool~ maintain_aspect_ratio
        +Option~Duration~ min_suggested_duration
        +Option~String~ api_framework
        +Option~String~ creative_type
        +Vec~StaticResource~ static_resources
        +Vec~IFrameResource~ iframe_resources
        +Vec~HTMLResource~ html_resources
        +Option~String~ click_through
        +Vec~String~ click_trackings
        +get_best_resource(&self) -> Option~&dyn AdResource~
        +get_display_area(&self) -> (i32, i32, i32, i32)
    }
    
    class CompanionAd {
        +String id
        +i32 width
        +i32 height
        +Option~i32~ asset_width
        +Option~i32~ asset_height
        +Option~i32~ expanded_width
        +Option~i32~ expanded_height
        +Option~String~ api_framework
        +Option~String~ ad_slot_id
        +Vec~StaticResource~ static_resources
        +Vec~IFrameResource~ iframe_resources
        +Vec~HTMLResource~ html_resources
        +Vec~TrackingEvent~ tracking_events
        +Option~String~ click_through
        +Vec~String~ click_trackings
        +matches_slot(&self, slot: &AdSlot) -> bool
        +get_companion_resource(&self) -> Option~&dyn AdResource~
    }
    
    VASTDocument *-- Ad
    Ad *-- AdSystem
    Ad *-- Creative
    Creative *-- Linear
    Creative *-- NonLinear
    Creative *-- CompanionAd
    Linear *-- MediaFile
    Linear *-- TrackingEvent
    Linear *-- VideoClicks
    
    NonLinear *-- TrackingEvent
    CompanionAd *-- TrackingEvent
```

##### VAST处理流程设计

```mermaid
sequenceDiagram
    participant Player as 视频播放器
    participant Parser as VAST解析器
    participant Validator as 验证器
    participant Selector as 媒体选择器
    participant Tracker as 跟踪器
    participant AdServer as 广告服务器
    
    Player->>Parser: 解析VAST XML
    Parser->>Parser: 构建VAST对象树
    Parser->>Validator: 验证VAST结构
    
    alt 验证通过
        Validator-->>Parser: 返回验证结果
        Parser->>Selector: 选择合适媒体文件
        Selector->>Selector: 匹配播放器规格
        Selector-->>Parser: 返回最佳媒体文件
        Parser-->>Player: 返回解析结果
        
        Player->>Player: 开始播放广告
        Player->>Tracker: 触发开始跟踪
        Tracker->>AdServer: 发送impression事件
        
        loop 播放过程中
            Player->>Tracker: 触发时间点事件
            Tracker->>AdServer: 发送tracking事件
        end
        
        Player->>Tracker: 触发完成跟踪
        Tracker->>AdServer: 发送complete事件
        
    else 验证失败
        Validator-->>Parser: 返回错误信息
        Parser->>Tracker: 发送错误跟踪
        Tracker->>AdServer: 发送error事件
        Parser-->>Player: 返回错误结果
    end
```

**VAST优化策略**：

- **媒体文件选择算法**：根据播放器能力、网络状况、设备性能选择最佳媒体文件
- **跟踪事件优化**：批量发送、去重处理、失败重试机制
- **缓存策略**：预解析VAST文档、媒体文件预加载、跟踪URL缓存
- **错误处理**：详细错误分类、降级处理、备用广告机制

#### 3.2.2 交互式广告支持

| 交互类型   | 实现方式     | 数据要求     | 技术实现 |
| ---------- | ------------ | ------------ | -------- |
| 可跳过广告 | 跳过按钮控制 | 时间节点配置 | 前端交互 |
| 可点击广告 | 点击区域定义 | 坐标和链接   | 事件处理 |
| 可暂停广告 | 暂停控制     | 状态管理     | 播放控制 |
| 可拖拽广告 | 拖拽交互     | 拖拽范围     | 手势识别 |

##### 交互式广告对象设计

```mermaid
classDiagram
    class InteractiveAd {
        <<abstract trait>>
        +String id
        +InteractionType interaction_type
        +bool is_enabled
        +std::collections::HashMap~String,serde_json::Value~ parameters
        +Vec~InteractionRule~ rules
        +InteractionState state
        +handle_interaction(&mut self, event: &InteractionEvent) -> Result~InteractionResult, InteractionError~
        +validate_interaction(&self, event: &InteractionEvent) -> bool
        +get_available_actions(&self) -> Vec~InteractionAction~
    }
    
    class SkippableAd {
        +Duration skip_offset
        +bool skip_button_visible
        +String skip_button_text
        +SkipButtonStyle button_style
        +Vec~String~ skip_tracking_urls
        +can_skip_at(&self, current_time: Duration) -> bool
        +show_skip_button(&mut self)
        +hide_skip_button(&mut self)
        +handle_skip(&mut self) -> Result~SkipResult, SkipError~
        +track_skip_event(&self)
    }
    
    class ClickableAd {
        +Vec~ClickZone~ click_zones
        +String click_through_url
        +Vec~String~ click_tracking_urls
        +bool open_in_new_window
        +ClickableState state
        +add_click_zone(&mut self, zone: ClickZone)
        +remove_click_zone(&mut self, zone_id: &str) -> Option~ClickZone~
        +handle_click(&mut self, click_event: &ClickEvent) -> Result~ClickResult, ClickError~
        +is_clickable_at(&self, location: &Point) -> bool
        +get_click_zone_at(&self, location: &Point) -> Option~&ClickZone~
    }
    
    class PausableAd {
        +bool is_pausable
        +bool is_paused
        +Option~Duration~ paused_at
        +Duration total_paused_time
        +i32 max_pause_count
        +i32 current_pause_count
        +Vec~String~ pause_tracking_urls
        +Vec~String~ resume_tracking_urls
        +pause(&mut self) -> Result~PauseResult, PauseError~
        +resume(&mut self) -> Result~ResumeResult, ResumeError~
        +can_pause(&self) -> bool
        +get_pause_overlay(&self) -> Option~PauseOverlay~
    }
    
    class DraggableAd {
        +Rectangle drag_bounds
        +Point current_position
        +Point initial_position
        +bool is_dragging
        +DragConstraints constraints
        +Vec~String~ drag_start_urls
        +Vec~String~ drag_end_urls
        +start_drag(&mut self, start_point: Point) -> Result~DragResult, DragError~
        +update_drag(&mut self, current_point: Point) -> Result~DragResult, DragError~
        +end_drag(&mut self, end_point: Point) -> Result~DragResult, DragError~
        +reset_position(&mut self)
        +is_within_bounds(&self, position: &Point) -> bool
    }
    
    class InteractionEvent {
        +String event_id
        +InteractionType interaction_type
        +chrono::DateTime~chrono::Utc~ timestamp
        +Point location
        +std::collections::HashMap~String,serde_json::Value~ event_data
        +Option~String~ user_id
        +Option~String~ device_id
        +Option~String~ user_agent
        +get_event_properties(&self) -> std::collections::HashMap~String,serde_json::Value~
        +validate(&self) -> bool
    }
    
    class InteractionRule {
        +String rule_id
        +String condition
        +InteractionAction action
        +bool is_enabled
        +std::collections::HashMap~String,serde_json::Value~ parameters
        +evaluate(&self, context: &InteractionContext) -> bool
        +execute(&self, context: &mut InteractionContext) -> Result~RuleResult, RuleError~
    }
    
    class ClickZone {
        +String id
        +Rectangle area
        +String click_url
        +Vec~String~ tracking_urls
        +bool is_active
        +Option~String~ tooltip
        +ClickZoneType zone_type
        +contains(&self, point: &Point) -> bool
        +get_click_data(&self) -> ClickData
        +set_active(&mut self, active: bool)
    }
    
    class InteractionTracker {
        +String tracking_id
        +Vec~TrackingPixel~ pixels
        +std::collections::HashMap~String,Vec~String~~ event_urls
        +track_interaction(&self, event: &InteractionEvent) -> Result~(), TrackingError~
        +batch_track_events(&self, events: &[InteractionEvent]) -> Result~(), TrackingError~
        +get_tracking_urls(&self, interaction_type: InteractionType) -> Vec~&str~
        +send_tracking_pixel(&self, url: &str, params: &std::collections::HashMap~String,String~) -> Result~(), TrackingError~
    }
    
    InteractiveAd <|-- SkippableAd
    InteractiveAd <|-- ClickableAd
    InteractiveAd <|-- PausableAd
    InteractiveAd <|-- DraggableAd
    
    ClickableAd *-- ClickZone
    InteractiveAd *-- InteractionRule
    InteractiveAd --> InteractionEvent
    InteractiveAd --> InteractionTracker
```

##### 交互式广告处理流程

```mermaid
stateDiagram-v2
    [*] --> Loading
    Loading --> Ready : 广告加载完成
    Loading --> Error : 加载失败
    
    Ready --> Playing : 开始播放
    Playing --> Paused : 用户暂停
    Playing --> Skipped : 用户跳过
    Playing --> Clicked : 用户点击
    Playing --> Dragging : 开始拖拽
    Playing --> Completed : 播放完成
    
    Paused --> Playing : 用户恢复
    Paused --> Skipped : 用户跳过
    Paused --> Clicked : 用户点击
    
    Dragging --> Playing : 拖拽结束
    Dragging --> Paused : 拖拽中暂停
    
    Clicked --> Playing : 点击处理完成
    Clicked --> ExternalPage : 跳转外部页面
    
    Skipped --> Completed : 跳过完成
    Completed --> [*]
    Error --> [*]
    ExternalPage --> [*]
```

**交互功能实现要点**：

- **事件处理机制**：统一的事件模型，支持冒泡和捕获机制
- **状态管理**：复杂交互状态的维护和同步
- **跟踪监测**：详细的交互行为跟踪和数据收集
- **用户体验优化**：流畅的交互响应和视觉反馈
- **兼容性处理**：不同设备和浏览器的兼容性适配

### 3.3 第三方集成对象

#### 3.3.1 DSP集成对象

| 集成场景 | 对象设计       | 数据格式      | 同步策略 |
| -------- | -------------- | ------------- | -------- |
| 竞价请求 | 标准化请求对象 | JSON/Protobuf | 实时同步 |
| 竞价响应 | 统一响应格式   | JSON压缩      | 实时处理 |
| 数据回传 | 效果数据对象   | 批量格式      | 定时同步 |
| 结算对账 | 账单数据对象   | CSV/Excel     | 每日同步 |

#### 3.3.2 SSP集成对象

| 集成类型 | 数据交换     | 协议支持   | 质量保证 |
| -------- | ------------ | ---------- | -------- |
| 流量接入 | 流量数据对象 | OpenRTB    | 流量验证 |
| 广告投放 | 投放指令对象 | 标准协议   | 投放监控 |
| 效果监测 | 监测数据对象 | 自定义协议 | 数据校验 |
| 收益分成 | 分成数据对象 | 财务协议   | 对账机制 |
