# Lorn.ADSP-Rust 开发路线图（Rust 技术栈）

## 项目概述

本路线图基于 Rust 技术栈（Rust 1.75+、Tokio、Axum、SeaORM、Tauri），对齐《README.md》和《系统整体技术架构》，遵循 IAB 标准（OpenRTB、VAST、VMAP、AdCOM），采用敏捷迭代与TDD（先测后码、红绿重构）推进。

核心目标：在保证内存安全与低延迟的前提下，构建可水平扩展、标准合规的广告投放平台，覆盖广告主/媒体、投放引擎、数据与生态对接全链路。

## 开发阶段规划

### 阶段一：工作空间与基础设施 (MVP-Infra)
 
时间：2个月（4个 Sprint）
目标：完成 Cargo 工作空间脚手架、统一配置与依赖注入、可运行样例与 CI 门禁。

Sprint 1-2：工作空间与基础能力

- [ ] 完成 Cargo 工作空间骨架与分层目录（参考 docs 中“Cargo工作空间组织架构”）
	- crates/04-core/shared, domain, application；05-infrastructure/config-abstractions, config-impl, di-abstractions, di-impl, composition；09-tools/component-macros
- [ ] 统一配置化与组件发现落地（已有基础：05-infrastructure/config-*、di-* 与 composition、examples/component_discovery_demo.rs、example-app）
- [ ] Web 最小可运行样例（Axum）与健康检查（presentation/web-api）
- [ ] 数据库抽象与迁移框架基线（SeaORM + migration crate；data-abstractions 协议定义）
- [ ] 观测性基线：tracing + OpenTelemetry + Prometheus exporter
- [ ] CI/CD（GitHub Actions）：cargo build/test、clippy -D warnings、fmt --check、doc

产品/技术设计工作项

- [ ] 明确 DDD 边界与 crate 依赖方向（向内依赖、trait 解耦、无环依赖）
- [ ] API 设计规范（docs_TecDesign/广告投放引擎/API设计规范.md）
- [ ] 配置与依赖注入技术设计回填（docs_TecDesign/系统配置化和依赖注入设计/*）

交付物

- 可运行 example-app（Axum + 配置/DI 基础）与最小健康检查端点
- CI 门禁生效的工作空间；质量基线文档与快速开始指南

阶段里程碑

- ✅ Cargo 工作空间规范化 & 配置/DI 基线可用
- ✅ CI 门禁（build/test/clippy/fmt）启用

---

### 阶段二：核心广告引擎与策略 (Core-Engine)
 
时间：3个月（6个 Sprint）
目标：实现高性能广告请求处理管道，完成召回/筛选/排序的策略引擎与数据访问抽象。

Sprint 3-4：广告请求处理骨架

- [ ] 广告引擎 HTTP 接入（Axum）与请求/响应模型（core + ad-engine-abstractions）
- [ ] 管道模式处理器：前置校验 → 召回 → 筛选 → 排序 → 计费/频控 → 渲染/响应
- [ ] Redis 缓存接入（caching-abstractions、caching-redis）与热点数据本地缓存
- [ ] 数据访问抽象（05-infrastructure/data-abstractions）与数据库实现选型（MySQL/PostgreSQL 任一）
- [ ] 异步 & backpressure 策略：Tokio runtime 配置、超时/重试/熔断

Sprint 5：策略引擎（Rust 实现）

- [ ] crates/03-strategies：recall、filter、ranking 与 common 的 trait 边界、可插拔机制
- [ ] 策略组合与配置化生效（由 composition 注入不同策略 pipeline）
- [ ] 基准测试（Criterion）与 p50/p95 延迟基线

Sprint 6：监控与可靠性

- [ ] 指标：QPS、延迟、命中率、错误率；日志关联 traceId/spanId；Jaeger 链路接入
- [ ] 测试：单测 + Testcontainers（数据库/Redis/Kafka/RabbitMQ 按需）+ 简易集成压测脚本
- [ ] 配置热加载与灰度发布开关（feature flag）

交付物

- 可在本地/容器环境跑通的广告引擎最小闭环
- 策略引擎可插拔运行与基准性能报告

阶段里程碑

- ✅ p50 < 20ms（本地/开发环境基线），功能正确性全链路通过
- ✅ 策略引擎 trait/模块化完成，可扩展

---

### 阶段三：IAB 标准与生态对接 (RTB & Video)
 
时间：3个月（6个 Sprint）
目标：实现 OpenRTB、VAST/VMAP 标准，对接 DSP/SSP/ADX 能力，完善消息与缓存策略。

Sprint 7-8：OpenRTB

- [ ] crates/06-external/openrtb：对象模型与序列化/反序列化
- [ ] BidRequest/BidResponse 处理管线、超时控制（< 100ms 总预算，内含策略与网络）
- [ ] DSP 适配器（dsp/）与并发竞价扇出/聚合
- [ ] 竞价监控指标与失败归因

Sprint 9：消息与异步组件

- [ ] Kafka（rdkafka）或 RabbitMQ（lapin）用于异步日志/效果/训练样本流水
- [ ] 反压策略、批量聚合与幂等设计

Sprint 10：视频广告

- [ ] crates/06-external/vast：VAST/VMAP 支持与校验
- [ ] 视频广告素材/进度事件上报规范；播放器 SDK 规划（07-client-sdk/）

交付物

- OpenRTB 2.5 标准实现与竞价闭环样例
- VAST/VMAP 兼容的基本投放能力与监测事件

阶段里程碑

- ✅ RTB 生态对接能力具备（联调样例通过）
- ✅ 视频广告标准打通（核心事件链路可用）

---

### 阶段四：数据与报表、反作弊与经营 (Data & Ops)
 
时间：3个月（6个 Sprint）
目标：完善数据采集、指标汇总、报表查询与基础反作弊，支撑经营分析。

Sprint 11-12：数据采集与处理

- [ ] 实时埋点与可靠上报（批量/压缩/重试）
- [ ] 明细流入 Kafka，离线/近实时聚合（可先内置作业，后续接 Spark/Flink）
- [ ] 指标宽表与查询 API（reporting/）

Sprint 13：反作弊与风控基线

- [ ] 设备/UA/IP 画像与频控/黑白名单
- [ ] 可插拔作弊特征检测（规则引擎 + 简易模型预留）

Sprint 14：经营与成本控制

- [ ] 预算/消耗监控、阈值预警
- [ ] 报表系统：维度/指标组合查询与导出

交付物

- 数据采集→汇总→查询的最小闭环
- 反作弊与频控基础能力

阶段里程碑

- ✅ 广告经营基础数据可查
- ✅ 反作弊与频控可控，误杀率与漏检率可评估

---

### 阶段五：客户端 SDK 与运营工具 (Clients & Console)
 
时间：2个月（4个 Sprint）
目标：提供跨端 SDK 与基础运营控制台，提升可用性。

Sprint 15：SDK

- [ ] crates/07-client-sdk/tauri、yew、typescript 的核心协议与最小渲染/上报能力
- [ ] UI 表现模型（ui-shared）与事件协议（shared）统一

Sprint 16：运营工具与后台

- [ ] Tauri 桌面监控工具（desktop-monitor）基础版
- [ ] Web Admin（Yew）最小可用：查看投放/素材/策略配置只读视图

交付物

- 三端 SDK 最小版与示例应用
- 基础运维/运营工具

阶段里程碑

- ✅ SDK 与后台工具跑通日常演示与验证

---

## 工程与质量门禁（持续）

必备门禁（CI 每次 PR 执行）

- cargo build --all --locked
- cargo test --all --locked
- cargo clippy --all-targets --all-features -- -D warnings
- cargo fmt --all -- --check

测试策略

- 单元测试覆盖核心业务与边界；Mockall 隔离外部依赖
- 集成测试使用 Testcontainers（DB/Redis/Kafka/RabbitMQ）
- 性能基准 Criterion；回归性能门槛 p50/p95 限值

安全与合规

- 第三方依赖审计（cargo deny 或等效）
- 隐私数据分级与脱敏；访问审计与最小权限

文档与设计

- 技术设计集中在 docs_TecDesign；架构图使用 Mermaid；与 crate 位置、trait 定义对齐

---

## 版本发布计划

版本规划（语义化）

- v0.1.0（MVP-Infra）：工作空间、配置/DI、示例应用与 CI 门禁
- v0.3.0（Core-Engine）：广告引擎 + 策略引擎闭环
- v0.5.0（RTB）：OpenRTB 联调可用
- v0.8.0（Video）：VAST/VMAP 基础支持
- v1.0.0（Enterprise）：数据/报表、反作弊、SDK 与后台可用

发布策略

- 所有发布经 e2e 冒烟与基准性能对比；支持灰度与回滚
- 提供 LTS 分支，安全修复优先

---

## 成功指标（与 README 一致化）

技术指标

- 投放响应：开发环境 p50 < 20ms、p95 < 50ms；RTB 超时保护 < 100ms
- 吞吐目标：阶段性 10万 QPS → 50万 QPS → 100万 QPS（分阶段压测）
- 可用性：> 99.9%
- 代码质量：核心逻辑测试覆盖 ≥ 95%，整体 ≥ 80%；clippy 零警告

业务指标

- 广告投放链路完整、策略效果可度量（CTR/CVR 监测）
- RTB/DSP/SSP 对接通畅，视频广告可用

开源指标

- Stars、贡献者与讨论区活跃度稳步上升；提供清晰的贡献指南

---

## 风险与对策（Rust 生态特有）

异步与并发

- 风险：Tokio 阻塞/饥饿、过度并发导致尾延迟升高
- 对策：限制并发、分级线程池、超时/重试/熔断与 backpressure

类型与生命周期复杂度

- 风险：trait 边界与生命周期约束导致实现复杂
- 对策：抽象收敛在 abstractions 层；模块内聚；尽量返回具体类型或 `Box<dyn Trait>`

数据库/缓存一致性

- 风险：多写入口与缓存失效
- 对策：写入先后与事务性策略；事件溯源或 outbox pattern；TTL + 订阅失效

标准兼容

- 风险：OpenRTB/VAST 细节差异
- 对策：建立合规模块与对照测试样本集

---

## 附：关键模块与路径对照（执行指引）

- 引擎与抽象：crates/04-core/ad-engine-abstractions、02-services/ad-engine
- 策略：crates/03-strategies/{recall|filter|ranking|common}
- 配置与DI：crates/05-infrastructure/{config-*,di-*,composition} + examples/
- 数据：crates/05-infrastructure/{data-abstractions,data-mysql,data-postgresql}
- 缓存与消息：crates/05-infrastructure/{caching-*,messaging-*}
- 外部协议：crates/06-external/{openrtb,vast}
- SDK 与后台：crates/07-client-sdk/{tauri,yew,typescript,ui-shared,shared}

—

本路线图将随进展与社区反馈持续更新，并与 docs_TecDesign 保持一致。
